<div class="distribution-page" dir="rtl">
  <!-- Back Button -->
  <div class="flex items-center mb-2">
    <button class="btn-back" (click)="goBack()">
      <span class="arrow-icon">â†’</span>
      {{ lang.t('distribution.back') }}
    </button>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="text-right">
      <h1 class="page-title">
        <span>ğŸ“¤</span> {{ lang.t('distribution.title') }}
      </h1>
      <p class="page-subtitle">
        {{ lang.t('distribution.subtitle') }}
      </p>
      
      <!-- Save Status Indicator -->
      @if (selectedQuestionnaire) {
        <div class="save-status-indicator" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
          @if (isSaving) {
            <span style="color: #9c27b0;">ğŸ’¾ ×©×•××¨...</span>
          } @else if (lastSaved) {
            <span style="color: #4caf50;">âœ“ × ×©××¨ {{ formatTime(lastSaved) }}</span>
          }
          @if (currentDistribution) {
            <span style="color: #2196f3; margin-right: 1rem;">âœ… ×™×© distribution ×¤×¢×™×œ</span>
          }
        </div>
      }
    </div>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Step 1: Select Questionnaire -->
    <div class="step-card gradient-green">
      <label class="step-label">×©×œ×‘ 1: ×‘×—×¨ ×©××œ×•×Ÿ</label>
      <select
        [(ngModel)]="selectedQuestionnaire"
        (ngModelChange)="onQuestionnaireChange()"
        class="select-input"
        name="questionnaire">
        <option value="">{{ lang.t('distribution.selectPlaceholder') || '×‘×—×¨ ×©××œ×•×Ÿ...' }}</option>
        @for (q of questionnaires; track q.id) {
          <option [value]="q.id">{{ q.title }}</option>
        }
      </select>
    </div>

    <!-- Step 2: Select Automatic Customer Response (Required) -->
    @if (selectedQuestionnaire) {
      <div class="step-card gradient-green">
        <div class="step-header-row">
          <label class="step-label">×©×œ×‘ 2: ×‘×—×¨ ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×— <span class="required-star">*</span></label>
          <button
            class="btn-create-template-outline"
            (click)="navigateToAutomations()">
            <span class="plus-icon">+</span>
            ×¦×•×¨ ××¢× ×” ×—×“×© ×œ×œ×§×•×—
            <span class="external-icon">â†—</span>
          </button>
        </div>

        <select
          [(ngModel)]="selectedTemplateId"
          (ngModelChange)="onTemplateChange($event)"
          class="select-input"
          name="template">
          <option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>
          <option value="none">×œ×œ× ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×—</option>
          @for (template of availableTemplates; track template.id) {
            <option [value]="template.id">{{ template.name }}</option>
          }
        </select>

        <!-- Info message if template was taken from bot -->
        @if (selectedTemplateId && selectedTemplateId !== 'none') {
          <div class="template-info-box">
            <span class="bot-icon">ğŸ¤–</span>
            <span>×ª×‘× ×™×ª ×–×• × ×œ×§×—×” ××‘×•×˜</span>
          </div>
        }

        <!-- Channel Selection (only when template is selected) -->
        @if (selectedTemplateId && selectedTemplateId !== 'none') {
          <div class="channels-selection">
            <label class="channels-label">
              ×‘×—×¨ ×¢×¨×•×¦×™ ×©×œ×™×—×” (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××”):
            </label>
            <div class="channels-checkboxes">
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('email')"
                  (change)="toggleChannel('email')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ“§</span>
                  {{ lang.t('distribution.channelEmail') }}
                </span>
              </label>
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('whatsapp')"
                  (change)="toggleChannel('whatsapp')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ’¬</span>
                  {{ lang.t('distribution.channelWhatsapp') }}
                </span>
              </label>
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('sms')"
                  (change)="toggleChannel('sms')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ“±</span>
                  {{ lang.t('distribution.channelSms') }}
                </span>
              </label>
            </div>
            @if (selectedChannels.length === 0) {
              <p class="channels-error-text">
                ×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×¢×¨×•×¥ ××—×“
              </p>
            }
          </div>
        }

        <!-- Error message if not selected -->
        @if (!isStep2Valid() && selectedQuestionnaire) {
          <p class="step-error-text">
            ×™×© ×œ×‘×—×•×¨ ××¢× ×” ××•×˜×•××˜×™ ××• "×œ×œ× ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×—" ×›×“×™ ×œ×”××©×™×š
          </p>
        }
      </div>
    }

    <!-- Step 3: Distribution Links (Only after template selection) -->
    @if (canShowStep3()) {
      <div class="step-card gradient-purple">
        <label class="step-label">×©×œ×‘ 3: ×§×™×©×•×¨×™ ×”×¤×¦×”</label>

        <!-- Info box about automatic detection -->
        <div class="info-box">
          <span class="bot-icon">ğŸ¤–</span>
          <span>×”×œ×™× ×§ ×™×–×”×” ××•×˜×•××˜×™×ª ××ª ×”××™×§×•× (WhatsApp, ××ª×¨, ×“×£ × ×—×™×ª×”) ×›×©××™×©×”×• ×œ×•×—×¥ ×¢×œ×™×•</span>
        </div>

        <!-- Link Rows: Form, Chat, QR -->
        <div class="links-container space-y-4">
          <!-- Row 1: Form Link -->
          <div class="link-row">
            <div class="link-row-header">
              <span class="file-icon">ğŸ“„</span>
              <span class="link-type-label">×œ×™× ×§ ×˜×•×¤×¡</span>
            </div>

            <!-- Custom Text Section (First - Text on top) -->
            <div class="custom-text-section">
              <label class="custom-text-label">
                ×˜×§×¡×˜ ××•×ª×× ××™×©×™×ª (××•×¤×¦×™×•× ×œ×™) - ×‘×¢×ª ×”×¢×ª×§×” ×™×•×¢×ª×§ ×”××œ×œ ×•×”×œ×™× ×§ ×™×—×“
              </label>
              <div class="custom-text-box">
                <input
                  [(ngModel)]="linkTexts['form']"
                  (ngModelChange)="onTextChange()"
                  placeholder="×”×›× ×¡ ×›××Ÿ ××ª ×”××œ×œ ×©×‘×• ×ª×¨×¦×” ×©×”×œ×™× ×§ ×™×•×¤×™×¢..."
                  class="custom-text-input"
                  dir="rtl"
                  type="text"
                />
                <button
                  class="btn-save-text"
                  (click)="saveCustomText('form')"
                  [class.saved]="savedTexts['form'] && savedTexts['form'].trim()">
                  <span class="save-icon">ğŸ’¾</span>
                  ×©××•×¨
                </button>
              </div>
              @if (linkTexts['form']?.trim()) {
                <p class="preview-text">
                  <span class="preview-label">×ª×¦×•×’×” ××§×“×™××”:</span> {{ linkTexts['form'] }}
                </p>
              }
              @if (savedTexts['form'] && savedTexts['form'].trim()) {
                <p class="saved-indicator">
                  <span class="check-icon">âœ“</span>
                  ×”××œ×œ × ×©××¨ - ×™×•×¤×™×¢ ×‘×©×•×¨×” ×”×©× ×™×™×” ×›×§×™×©×•×¨ ×§×œ×™×§×‘×™×œ×™ ×¢× ××¤×©×¨×•×ª ×”×¢×ª×§×”
                </p>
              }
            </div>

            <!-- Link Display: Row 1 - Link with copy -->
            <div class="link-row-first">
              <code class="link-url-text">{{ formLink || '×œ× ×–××™×Ÿ' }}</code>
              <button class="copy-btn" (click)="copyLink(formLink, 'form')" [disabled]="!formLink" title="×”×¢×ª×§ ×œ×™× ×§">
                <span class="copy-icon">ğŸ“‹</span>
              </button>
            </div>

            <!-- Row 2 - Clickable text link (if text saved) -->
            @if (savedTexts['form'] && savedTexts['form'].trim()) {
              <div class="link-row-second">
                <a [href]="formLink" target="_blank" class="clickable-text-link">
                  {{ savedTexts['form'] }}
                </a>
                <button class="copy-btn-link" (click)="copyClickableLink(formLink, 'form')" title="×”×¢×ª×§ ××œ×œ ×›×§×™×©×•×¨ ×§×œ×™×§×‘×™×œ×™">
                  <span class="copy-icon">ğŸ“‹</span>
                </button>
              </div>
            }

            <!-- Action Buttons -->
            <div class="action-buttons-row">
              <button class="action-btn preview-btn" (click)="previewLink(formLink, 'form')" [disabled]="!formLink">
                ×”×¦×’ ×˜×•×¤×¡
              </button>
              <button class="action-btn edit-btn" (click)="editQuestionnaire()">
                ×¢×¨×™×›×”
              </button>
            </div>

          </div>

          <!-- Row 2: Chat Link -->
          <div class="link-row">
            <div class="link-row-header">
              <span class="chat-icon">ğŸ’¬</span>
              <span class="link-type-label">×œ×™× ×§ ×¦'××˜</span>
            </div>

            <!-- Custom Text Section (First - Text on top) -->
            <div class="custom-text-section">
              <label class="custom-text-label">
                ×˜×§×¡×˜ ××•×ª×× ××™×©×™×ª (××•×¤×¦×™×•× ×œ×™) - ×‘×¢×ª ×”×¢×ª×§×” ×™×•×¢×ª×§ ×”××œ×œ ×•×”×œ×™× ×§ ×™×—×“
              </label>
              <div class="custom-text-box">
                <input
                  [(ngModel)]="linkTexts['chat']"
                  (ngModelChange)="onTextChange()"
                  placeholder="×”×›× ×¡ ×›××Ÿ ××ª ×”××œ×œ ×©×‘×• ×ª×¨×¦×” ×©×”×œ×™× ×§ ×™×•×¤×™×¢..."
                  class="custom-text-input"
                  dir="rtl"
                  type="text"
                />
                <button
                  class="btn-save-text"
                  (click)="saveCustomText('chat')"
                  [class.saved]="savedTexts['chat'] && savedTexts['chat'].trim()">
                  <span class="save-icon">ğŸ’¾</span>
                  ×©××•×¨
                </button>
              </div>
              @if (linkTexts['chat']?.trim()) {
                <p class="preview-text">
                  <span class="preview-label">×ª×¦×•×’×” ××§×“×™××”:</span> {{ linkTexts['chat'] }}
                </p>
              }
              @if (savedTexts['chat'] && savedTexts['chat'].trim()) {
                <p class="saved-indicator">
                  <span class="check-icon">âœ“</span>
                  ×”××œ×œ × ×©××¨ - ×™×•×¤×™×¢ ×‘×©×•×¨×” ×”×©× ×™×™×” ×›×§×™×©×•×¨ ×§×œ×™×§×‘×™×œ×™ ×¢× ××¤×©×¨×•×ª ×”×¢×ª×§×”
                </p>
              }
            </div>

            <!-- Link Display: Row 1 - Link with copy -->
            <div class="link-row-first">
              <code class="link-url-text">{{ chatLink || '×œ× ×–××™×Ÿ' }}</code>
              <button class="copy-btn" (click)="copyLink(chatLink, 'chat')" [disabled]="!chatLink" title="×”×¢×ª×§ ×œ×™× ×§">
                <span class="copy-icon">ğŸ“‹</span>
              </button>
            </div>

            <!-- Row 2 - Clickable text link (if text saved) -->
            @if (savedTexts['chat'] && savedTexts['chat'].trim()) {
              <div class="link-row-second">
                <a [href]="chatLink" target="_blank" class="clickable-text-link">
                  {{ savedTexts['chat'] }}
                </a>
                <button class="copy-btn-link" (click)="copyClickableLink(chatLink, 'chat')" title="×”×¢×ª×§ ××œ×œ ×›×§×™×©×•×¨ ×§×œ×™×§×‘×™×œ×™">
                  <span class="copy-icon">ğŸ“‹</span>
                </button>
              </div>
            }

            <!-- Action Buttons -->
            <div class="action-buttons-row">
              <button class="action-btn preview-btn" (click)="previewLink(chatLink, 'chat')" [disabled]="!chatLink">
                ×”×¦×’ ×¦'××˜
              </button>
              <button class="action-btn edit-btn" (click)="editQuestionnaire()">
                ×¢×¨×™×›×”
              </button>
            </div>

          </div>

          <!-- Row 3: QR Link -->
          <div class="link-row">
            <div class="link-row-header">
              <span class="qr-icon">ğŸ“±</span>
              <span class="link-type-label">×œ×™× ×§ QR</span>
            </div>

            <!-- Custom Text Section (First - Text on top) -->
            <div class="custom-text-section">
              <label class="custom-text-label">
                ×˜×§×¡×˜ ××•×ª×× ××™×©×™×ª (××•×¤×¦×™×•× ×œ×™) - ×‘×¢×ª ×”×¢×ª×§×” ×™×•×¢×ª×§ ×”××œ×œ ×•×”×œ×™× ×§ ×™×—×“
              </label>
              <div class="custom-text-box">
                <input
                  [(ngModel)]="linkTexts['qr']"
                  (ngModelChange)="onTextChange()"
                  placeholder="×”×›× ×¡ ×›××Ÿ ××ª ×”××œ×œ ×©×‘×• ×ª×¨×¦×” ×©×”×œ×™× ×§ ×™×•×¤×™×¢..."
                  class="custom-text-input"
                  dir="rtl"
                  type="text"
                />
                <button
                  class="btn-save-text"
                  (click)="saveCustomText('qr')"
                  [class.saved]="savedTexts['qr'] && savedTexts['qr'].trim()">
                  <span class="save-icon">ğŸ’¾</span>
                  ×©××•×¨
                </button>
              </div>
              @if (linkTexts['qr']?.trim()) {
                <p class="preview-text">
                  <span class="preview-label">×ª×¦×•×’×” ××§×“×™××”:</span> {{ linkTexts['qr'] }}
                </p>
              }
              @if (savedTexts['qr'] && savedTexts['qr'].trim()) {
                <p class="saved-indicator">
                  <span class="check-icon">âœ“</span>
                  ×”××œ×œ × ×©××¨ - ×™×•×¤×™×¢ ×‘×©×•×¨×” ×”×©× ×™×™×” ×›×§×™×©×•×¨ ×§×œ×™×§×‘×™×œ×™ ×¢× ××¤×©×¨×•×ª ×”×¢×ª×§×”
                </p>
              }
            </div>

            <!-- Link Display: Row 1 - Link with copy -->
            <div class="link-row-first">
              <code class="link-url-text">{{ qrLink || '×œ× ×–××™×Ÿ' }}</code>
              <button class="copy-btn" (click)="copyLink(qrLink, 'qr')" [disabled]="!qrLink" title="×”×¢×ª×§ ×œ×™× ×§">
                <span class="copy-icon">ğŸ“‹</span>
              </button>
            </div>

            <!-- Row 2 - Clickable text link (if text saved) -->
            @if (savedTexts['qr'] && savedTexts['qr'].trim()) {
              <div class="link-row-second">
                <a [href]="qrLink" target="_blank" class="clickable-text-link">
                  {{ savedTexts['qr'] }}
                </a>
                <button class="copy-btn-link" (click)="copyClickableLink(qrLink, 'qr')" title="×”×¢×ª×§ ××œ×œ ×›×§×™×©×•×¨ ×§×œ×™×§×‘×™×œ×™">
                  <span class="copy-icon">ğŸ“‹</span>
                </button>
              </div>
            }

            <!-- Action Buttons -->
            <div class="action-buttons-row">
              <button class="action-btn preview-btn" (click)="previewLink(qrLink, 'qr')" [disabled]="!qrLink">
                ×”×¦×’ QR
              </button>
              <button class="action-btn edit-btn" (click)="editQuestionnaire()">
                ×¢×¨×™×›×”
              </button>
            </div>

          </div>
        </div>
      </div>
    }

  </div>
</div>
