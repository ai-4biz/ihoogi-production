<div class="distribution-page" dir="rtl">
  <!-- Back Button -->
  <div class="flex items-center mb-2">
    <button class="btn-back" (click)="goBack()">
      <span class="arrow-icon">→</span>
      {{ lang.t('distribution.back') }}
    </button>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="text-right">
      <h1 class="page-title">
        <span>📤</span> {{ lang.t('distribution.title') }}
      </h1>
      <p class="page-subtitle">
        {{ lang.t('distribution.subtitle') }}
      </p>
    </div>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Step 1: Select Questionnaire -->
    <div class="step-card gradient-green">
      <label class="step-label">שלב 1: בחר שאלון</label>
      <select
        [(ngModel)]="selectedQuestionnaire"
        (ngModelChange)="onQuestionnaireChange()"
        class="select-input"
        name="questionnaire">
        <option value="">{{ lang.t('distribution.selectPlaceholder') || 'בחר שאלון...' }}</option>
        @for (q of questionnaires; track q.id) {
          <option [value]="q.id">{{ q.title }}</option>
        }
      </select>
    </div>

    <!-- Step 2: Select Automatic Customer Response (Required) -->
    @if (selectedQuestionnaire) {
      <div class="step-card gradient-green">
        <div class="step-header-row">
          <label class="step-label">שלב 2: בחר מענה אוטומטי ללקוח <span class="required-star">*</span></label>
          <button
            class="btn-create-template-outline"
            (click)="navigateToAutomations()">
            <span class="plus-icon">+</span>
            צור מענה חדש ללקוח
            <span class="external-icon">↗</span>
          </button>
        </div>

        <select
          [(ngModel)]="selectedTemplateId"
          (ngModelChange)="onTemplateChange($event)"
          class="select-input"
          name="template">
          <option value="">בחר תבנית...</option>
          <option value="none">ללא מענה אוטומטי ללקוח</option>
          @for (template of availableTemplates; track template.id) {
            <option [value]="template.id">{{ template.name }}</option>
          }
        </select>

        <!-- Info message if template was taken from bot -->
        @if (selectedTemplateId && selectedTemplateId !== 'none') {
          <div class="template-info-box">
            <span class="bot-icon">🤖</span>
            <span>תבנית זו נלקחה מבוט</span>
          </div>
        }

        <!-- Error message if not selected -->
        @if (!isStep2Valid() && selectedQuestionnaire) {
          <p class="step-error-text">
            יש לבחור מענה אוטומטי או "ללא מענה אוטומטי ללקוח" כדי להמשיך
          </p>
        }
      </div>
    }

    <!-- Step 3: Distribution Links (Only after template selection) -->
    @if (canShowStep3()) {
      <div class="step-card gradient-purple">
        <label class="step-label">שלב 3: קישורי הפצה</label>

        <!-- Info box about automatic detection -->
        <div class="info-box">
          <span class="bot-icon">🤖</span>
          <span>הלינק יזהה אוטומטית את המיקום (WhatsApp, אתר, דף נחיתה) כשמישהו לוחץ עליו</span>
        </div>

        <!-- Link Rows: Form, Chat, QR -->
        <div class="links-container space-y-4">
          <!-- Row 1: Form Link -->
          <div class="link-row">
            <div class="link-row-header">
              <span class="file-icon">📄</span>
              <span class="link-type-label">לינק טופס</span>
            </div>

            <!-- Link Display -->
            <div class="link-box">
              <code class="link-url-text">{{ formLink || 'לא זמין' }}</code>
              <button class="copy-btn" (click)="copyLink(formLink, 'form')" [disabled]="!formLink">
                <span class="copy-icon">📋</span>
              </button>
            </div>

            <!-- Custom Text Section -->
            <div class="custom-text-section">
              <div class="custom-text-header">
                <label class="custom-text-label">
                  טקסט מותאם אישית (אופציונלי) - הלינק יופיע כמלל זה בעת העתקה
                </label>
                <button
                  class="btn-save-text"
                  (click)="saveCustomText('form')"
                  [class.saved]="savedTexts['form'] && savedTexts['form'].trim()">
                  <span class="save-icon">💾</span>
                  שמור
                </button>
              </div>
              <textarea
                [(ngModel)]="linkTexts['form']"
                placeholder="הכנס כאן את המלל שבו תרצה שהלינק יופיע..."
                class="custom-textarea"
                dir="rtl"
                rows="3"
              ></textarea>
              @if (linkTexts['form']?.trim()) {
                <p class="preview-text">
                  <span class="preview-label">תצוגה מקדימה:</span> {{ linkTexts['form'] }}
                </p>
              }
              @if (savedTexts['form'] && savedTexts['form'].trim()) {
                <p class="saved-indicator">
                  <span class="check-icon">✓</span>
                  המלל נשמר - בעת העתקה יועתק המלל במקום הלינק
                </p>
              }
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-row">
              <button class="action-btn preview-btn" (click)="previewLink(formLink, 'form')" [disabled]="!formLink">
                הצג טופס
              </button>
              <button class="action-btn demo-btn" (click)="previewTemplate()" [disabled]="selectedTemplateId === 'none' || !selectedTemplateId">
                דמו מענה ללקוח
              </button>
              <button class="action-btn edit-btn" (click)="editQuestionnaire()">
                עריכה
              </button>
              <button class="action-btn delete-btn" (click)="deleteQuestionnaire()">
                מחיקה
              </button>
            </div>
          </div>

          <!-- Row 2: Chat Link -->
          <div class="link-row">
            <div class="link-row-header">
              <span class="chat-icon">💬</span>
              <span class="link-type-label">לינק צ'אט</span>
            </div>

            <div class="link-box">
              <code class="link-url-text">{{ chatLink || 'לא זמין' }}</code>
              <button class="copy-btn" (click)="copyLink(chatLink, 'chat')" [disabled]="!chatLink">
                <span class="copy-icon">📋</span>
              </button>
            </div>

            <div class="custom-text-section">
              <div class="custom-text-header">
                <label class="custom-text-label">
                  טקסט מותאם אישית (אופציונלי) - הלינק יופיע כמלל זה בעת העתקה
                </label>
                <button
                  class="btn-save-text"
                  (click)="saveCustomText('chat')"
                  [class.saved]="savedTexts['chat'] && savedTexts['chat'].trim()">
                  <span class="save-icon">💾</span>
                  שמור
                </button>
              </div>
              <textarea
                [(ngModel)]="linkTexts['chat']"
                placeholder="הכנס כאן את המלל שבו תרצה שהלינק יופיע..."
                class="custom-textarea"
                dir="rtl"
                rows="3"
              ></textarea>
              @if (linkTexts['chat']?.trim()) {
                <p class="preview-text">
                  <span class="preview-label">תצוגה מקדימה:</span> {{ linkTexts['chat'] }}
                </p>
              }
              @if (savedTexts['chat'] && savedTexts['chat'].trim()) {
                <p class="saved-indicator">
                  <span class="check-icon">✓</span>
                  המלל נשמר - בעת העתקה יועתק המלל במקום הלינק
                </p>
              }
            </div>

            <div class="action-buttons-row">
              <button class="action-btn preview-btn" (click)="previewLink(chatLink, 'chat')" [disabled]="!chatLink">
                הצג צ'אט
              </button>
              <button class="action-btn demo-btn" (click)="previewTemplate()" [disabled]="selectedTemplateId === 'none' || !selectedTemplateId">
                דמו מענה ללקוח
              </button>
              <button class="action-btn edit-btn" (click)="editQuestionnaire()">
                עריכה
              </button>
              <button class="action-btn delete-btn" (click)="deleteQuestionnaire()">
                מחיקה
              </button>
            </div>
          </div>

          <!-- Row 3: QR Link -->
          <div class="link-row">
            <div class="link-row-header">
              <span class="qr-icon">📱</span>
              <span class="link-type-label">לינק QR</span>
            </div>

            <div class="link-box">
              <code class="link-url-text">{{ qrLink || 'לא זמין' }}</code>
              <button class="copy-btn" (click)="copyLink(qrLink, 'qr')" [disabled]="!qrLink">
                <span class="copy-icon">📋</span>
              </button>
            </div>

            <div class="custom-text-section">
              <div class="custom-text-header">
                <label class="custom-text-label">
                  טקסט מותאם אישית (אופציונלי) - הלינק יופיע כמלל זה בעת העתקה
                </label>
                <button
                  class="btn-save-text"
                  (click)="saveCustomText('qr')"
                  [class.saved]="savedTexts['qr'] && savedTexts['qr'].trim()">
                  <span class="save-icon">💾</span>
                  שמור
                </button>
              </div>
              <textarea
                [(ngModel)]="linkTexts['qr']"
                placeholder="הכנס כאן את המלל שבו תרצה שהלינק יופיע..."
                class="custom-textarea"
                dir="rtl"
                rows="3"
              ></textarea>
              @if (linkTexts['qr']?.trim()) {
                <p class="preview-text">
                  <span class="preview-label">תצוגה מקדימה:</span> {{ linkTexts['qr'] }}
                </p>
              }
              @if (savedTexts['qr'] && savedTexts['qr'].trim()) {
                <p class="saved-indicator">
                  <span class="check-icon">✓</span>
                  המלל נשמר - בעת העתקה יועתק המלל במקום הלינק
                </p>
              }
            </div>

            <div class="action-buttons-row">
              <button class="action-btn preview-btn" (click)="previewLink(qrLink, 'qr')" [disabled]="!qrLink">
                הצג QR
              </button>
              <button class="action-btn demo-btn" (click)="previewTemplate()" [disabled]="selectedTemplateId === 'none' || !selectedTemplateId">
                דמו מענה ללקוח
              </button>
              <button class="action-btn edit-btn" (click)="editQuestionnaire()">
                עריכה
              </button>
              <button class="action-btn delete-btn" (click)="deleteQuestionnaire()">
                מחיקה
              </button>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Legacy: Show Links Button (for backward compatibility) -->
    @if (canShowStep3() && !showLinksSection) {
      <div class="show-links-section">
        <button
          class="btn-show-links"
          (click)="handleShowLinks()">
          <span class="link-icon">🔗</span>
          {{ lang.t('distribution.generateLinks') || 'הצג קישורים' }}
        </button>
      </div>
    }

  </div>
</div>
