<div class="distribution-page" dir="rtl">
  <!-- Back Button -->
  <div class="flex items-center mb-2">
    <button class="btn-back" (click)="goBack()">
      <span class="arrow-icon">â†’</span>
      {{ lang.t('distribution.back') }}
    </button>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="text-right">
      <h1 class="page-title">
        <span>ğŸ“¤</span> {{ lang.t('distribution.title') }}
      </h1>
      <p class="page-subtitle">
        {{ lang.t('distribution.subtitle') }}
      </p>
      
      <!-- Save Status Indicator -->
      @if (selectedQuestionnaire) {
        <div class="save-status-indicator" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
          @if (isSaving) {
            <span style="color: #9c27b0;">ğŸ’¾ ×©×•××¨...</span>
          } @else if (lastSaved) {
            <span style="color: #4caf50;">âœ“ × ×©××¨ {{ formatTime(lastSaved) }}</span>
          }
          @if (currentDistribution) {
            <span style="color: #2196f3; margin-right: 1rem;">âœ… ×™×© distribution ×¤×¢×™×œ</span>
          }
        </div>
      }
    </div>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Step 1: Select Questionnaire -->
    <div class="step-card gradient-green">
      <label class="step-label">×©×œ×‘ 1: ×‘×—×¨ ×©××œ×•×Ÿ</label>
      <select
        [(ngModel)]="selectedQuestionnaire"
        (ngModelChange)="onQuestionnaireChange()"
        class="select-input"
        name="questionnaire">
        <option value="">{{ lang.t('distribution.selectPlaceholder') || '×‘×—×¨ ×©××œ×•×Ÿ...' }}</option>
        @for (q of questionnaires; track q.id) {
          <option [value]="q.id">{{ q.title }}</option>
        }
      </select>
    </div>

    <!-- Step 2: Select Automatic Customer Response (Required) -->
    @if (selectedQuestionnaire) {
      <div class="step-card gradient-green">
        <div class="step-header-row">
          <label class="step-label">×©×œ×‘ 2: ×‘×—×¨ ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×— <span class="required-star">*</span></label>
          <button
            class="btn-create-template-outline"
            (click)="navigateToAutomations()">
            <span class="plus-icon">+</span>
            ×¦×•×¨ ××¢× ×” ×—×“×© ×œ×œ×§×•×—
            <span class="external-icon">â†—</span>
          </button>
        </div>

        <select
          [(ngModel)]="selectedTemplateId"
          (ngModelChange)="onTemplateChange($event)"
          class="select-input"
          name="template">
          <option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>
          <option value="none">×œ×œ× ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×—</option>
          @for (template of availableTemplates; track template.id) {
            <option [value]="template.id">{{ template.name }}</option>
          }
        </select>

        <!-- Info message if template was taken from bot -->
        @if (selectedTemplateId && selectedTemplateId !== 'none') {
          <div class="template-info-box">
            <span class="bot-icon">ğŸ¤–</span>
            <span>×ª×‘× ×™×ª ×–×• × ×œ×§×—×” ××‘×•×˜</span>
          </div>
        }

        <!-- Channel Selection (only when template is selected) -->
        @if (selectedTemplateId && selectedTemplateId !== 'none') {
          <div class="channels-selection">
            <label class="channels-label">
              ×‘×—×¨ ×¢×¨×•×¦×™ ×©×œ×™×—×” (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××”):
            </label>
            <div class="channels-checkboxes">
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('email')"
                  (change)="toggleChannel('email')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ“§</span>
                  Email
                </span>
              </label>
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('whatsapp')"
                  (change)="toggleChannel('whatsapp')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ’¬</span>
                  WhatsApp
                </span>
              </label>
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('sms')"
                  (change)="toggleChannel('sms')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ“±</span>
                  SMS
                </span>
              </label>
            </div>
            @if (selectedChannels.length === 0) {
              <p class="channels-error-text">
                ×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×¢×¨×•×¥ ××—×“
              </p>
            }
          </div>
        }

        <!-- Error message if not selected -->
        @if (!isStep2Valid() && selectedQuestionnaire) {
          <p class="step-error-text">
            ×™×© ×œ×‘×—×•×¨ ××¢× ×” ××•×˜×•××˜×™ ××• "×œ×œ× ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×—" ×›×“×™ ×œ×”××©×™×š
          </p>
        }
      </div>
    }

    <!-- Step 3: Distribution Links (Only after template selection) -->
    @if (canShowStep3()) {
      <div class="step-card gradient-purple">
        <label class="step-label">×©×œ×‘ 3: ×§×™×©×•×¨×™ ×”×¤×¦×”</label>

        <!-- Custom Text Section (One for all links) -->
        <div class="custom-text-section-simple">
          <label class="custom-text-label-simple">
            ×˜×§×¡×˜ ××•×ª×× ××™×©×™×ª (××•×¤×¦×™×•× ×œ×™) - ×‘×¢×ª ×”×¢×ª×§×” ×™×•×¢×ª×§ ×”××œ×œ ×•×”×œ×™× ×§ ×™×—×“
          </label>
          <div class="custom-text-box-simple">
            <input
              [(ngModel)]="linkTexts['form']"
              (ngModelChange)="onTextChange()"
              placeholder="×”×›× ×¡ ×›××Ÿ ××ª ×”××œ×œ ×©×‘×• ×ª×¨×¦×” ×©×”×œ×™× ×§ ×™×•×¤×™×¢..."
              class="custom-text-input-simple"
              dir="rtl"
              type="text"
            />
            <button
              class="btn-save-text-simple"
              (click)="saveCustomText('form')"
              [class.saved]="savedTexts['form'] && savedTexts['form'].trim()">
              <span class="save-icon">ğŸ’¾</span>
              ×©××•×¨
            </button>
          </div>
          @if (linkTexts['form']?.trim()) {
            <p class="preview-text-simple">
              <span class="preview-label-simple">×ª×¦×•×’×” ××§×“×™××”:</span> {{ linkTexts['form'] }}
            </p>
          }
          @if (savedTexts['form'] && savedTexts['form'].trim()) {
            <p class="saved-indicator-simple">
              <span class="check-icon">âœ“</span>
              ×”××œ×œ × ×©××¨ - ×™×•×¢×ª×§ ×¢× ×›×œ ×”×§×™×©×•×¨×™×
            </p>
          }
        </div>

        <!-- Link Rows: Form, Chat, QR - Simplified -->
        <div class="links-container-simple">
          <!-- Row 1: Form Link -->
          <div class="link-row-simple">
            <div class="link-label-simple">
              <span class="link-icon">ğŸ“„</span>
              <span>×œ×™× ×§ ×˜×•×¤×¡</span>
            </div>
            <div class="link-content-simple">
              <code class="link-url-simple">{{ formLink || '×œ× ×–××™×Ÿ' }}</code>
              <div class="copy-buttons-group">
                <button class="copy-btn-simple" (click)="copyLinkOnly(formLink, 'form')" [disabled]="!formLink" title="×”×¢×ª×§ ×œ×™× ×§ ×¨×’×™×œ">
                  ğŸ“‹ ×œ×™× ×§
                </button>
                <button class="copy-btn-simple copy-with-text" (click)="copyLinkWithText(formLink, 'form')" [disabled]="!formLink || !savedTexts['form'] || !savedTexts['form'].trim()" title="×”×¢×ª×§ ×œ×™× ×§ ×¢× ××œ×œ">
                  ğŸ“ ×¢× ××œ×œ
                </button>
              </div>
            </div>
          </div>

          <!-- Row 2: Chat Link -->
          <div class="link-row-simple">
            <div class="link-label-simple">
              <span class="link-icon">ğŸ’¬</span>
              <span>×œ×™× ×§ ×¦'××˜</span>
            </div>
            <div class="link-content-simple">
              <code class="link-url-simple">{{ chatLink || '×œ× ×–××™×Ÿ' }}</code>
              <div class="copy-buttons-group">
                <button class="copy-btn-simple" (click)="copyLinkOnly(chatLink, 'chat')" [disabled]="!chatLink" title="×”×¢×ª×§ ×œ×™× ×§ ×¨×’×™×œ">
                  ğŸ“‹ ×œ×™× ×§
                </button>
                <button class="copy-btn-simple copy-with-text" (click)="copyLinkWithText(chatLink, 'chat')" [disabled]="!chatLink || !savedTexts['form'] || !savedTexts['form'].trim()" title="×”×¢×ª×§ ×œ×™× ×§ ×¢× ××œ×œ">
                  ğŸ“ ×¢× ××œ×œ
                </button>
              </div>
            </div>
          </div>

          <!-- Row 3: QR Link -->
          <div class="link-row-simple">
            <div class="link-label-simple">
              <span class="link-icon">ğŸ“±</span>
              <span>×œ×™× ×§ QR</span>
            </div>
            <div class="link-content-simple">
              <code class="link-url-simple">{{ qrLink || '×œ× ×–××™×Ÿ' }}</code>
              <div class="copy-buttons-group">
                <button class="copy-btn-simple" (click)="copyLinkOnly(qrLink, 'qr')" [disabled]="!qrLink" title="×”×¢×ª×§ ×œ×™× ×§ ×¨×’×™×œ">
                  ğŸ“‹ ×œ×™× ×§
                </button>
                <button class="copy-btn-simple copy-with-text" (click)="copyLinkWithText(qrLink, 'qr')" [disabled]="!qrLink || !savedTexts['form'] || !savedTexts['form'].trim()" title="×”×¢×ª×§ ×œ×™× ×§ ×¢× ××œ×œ">
                  ğŸ“ ×¢× ××œ×œ
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Distribution Channels Section -->
        <div class="distribution-channels-section">
          <h3 class="channels-section-title">{{ lang.t('distribution.distributeVia') }}</h3>

          <!-- Group 1: Social Networks (with referrer) -->
          <div class="channels-group social-networks-group">
            <h4 class="group-title">{{ lang.t('distribution.socialNetworks') }}</h4>
            <div class="channels-grid social-grid">
              <button 
                class="channel-btn social-btn facebook"
                (click)="selectSocialNetwork('facebook')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.facebook') })">
                <span class="channel-icon">ğŸ“˜</span>
                <span class="channel-name">{{ lang.t('distribution.network.facebook') }}</span>
              </button>
              <button 
                class="channel-btn social-btn instagram"
                (click)="selectSocialNetwork('instagram')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.instagram') })">
                <span class="channel-icon">ğŸ“·</span>
                <span class="channel-name">{{ lang.t('distribution.network.instagram') }}</span>
              </button>
              <button 
                class="channel-btn social-btn linkedin"
                (click)="selectSocialNetwork('linkedin')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.linkedin') })">
                <span class="channel-icon">ğŸ’¼</span>
                <span class="channel-name">{{ lang.t('distribution.network.linkedin') }}</span>
              </button>
              <button 
                class="channel-btn social-btn youtube"
                (click)="selectSocialNetwork('youtube')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.youtube') })">
                <span class="channel-icon">ğŸ“º</span>
                <span class="channel-name">{{ lang.t('distribution.network.youtube') }}</span>
              </button>
              <button 
                class="channel-btn social-btn tiktok"
                (click)="selectSocialNetwork('tiktok')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.tiktok') })">
                <span class="channel-icon">ğŸµ</span>
                <span class="channel-name">{{ lang.t('distribution.network.tiktok') }}</span>
              </button>
              <button 
                class="channel-btn social-btn twitter"
                (click)="selectSocialNetwork('twitter')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.twitter') })">
                <span class="channel-icon">ğŸ¦</span>
                <span class="channel-name">{{ lang.t('distribution.network.twitter') }}</span>
              </button>
              <button 
                class="channel-btn social-btn pinterest"
                (click)="selectSocialNetwork('pinterest')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.pinterest') })">
                <span class="channel-icon">ğŸ“Œ</span>
                <span class="channel-name">{{ lang.t('distribution.network.pinterest') }}</span>
              </button>
              <button 
                class="channel-btn social-btn reddit"
                (click)="selectSocialNetwork('reddit')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.reddit') })">
                <span class="channel-icon">ğŸ”´</span>
                <span class="channel-name">{{ lang.t('distribution.network.reddit') }}</span>
              </button>
            </div>
          </div>

          <!-- Group 2: Email, SMS, WhatsApp (no referrer) -->
          <div class="channels-group main-channels-group">
            <h4 class="group-title">{{ lang.t('distribution.mainChannels') }}</h4>
            <div class="channels-grid main-grid">
              <button 
                class="channel-btn main-btn email"
                (click)="selectSocialNetwork('email')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.email') })">
                <span class="channel-icon">ğŸ“§</span>
                <span class="channel-name">{{ lang.t('distribution.network.email') }}</span>
              </button>
              <button 
                class="channel-btn main-btn sms"
                (click)="selectSocialNetwork('sms')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.sms') })">
                <span class="channel-icon">ğŸ“±</span>
                <span class="channel-name">{{ lang.t('distribution.network.sms') }}</span>
              </button>
              <button 
                class="channel-btn main-btn whatsapp"
                (click)="selectSocialNetwork('whatsapp')"
                [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.whatsapp') })">
                <span class="channel-icon">ğŸ’¬</span>
                <span class="channel-name">{{ lang.t('distribution.network.whatsapp') }}</span>
              </button>
            </div>
          </div>

          <!-- Group 3: Additional Networks (dropdown/collapsible) -->
          <div class="channels-group additional-networks-group">
            <details class="additional-networks-details">
              <summary class="group-title summary-title">
                <span>{{ lang.t('distribution.additionalNetworks') }}</span>
                <span class="expand-icon">â–¼</span>
              </summary>
              <div class="channels-grid additional-grid">
                <button 
                  class="channel-btn additional-btn telegram"
                  (click)="selectSocialNetwork('telegram')"
                  [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.telegram') })">
                  <span class="channel-icon">âœˆï¸</span>
                  <span class="channel-name">{{ lang.t('distribution.network.telegram') }}</span>
                </button>
                <button 
                  class="channel-btn additional-btn website"
                  (click)="selectSocialNetwork('website')"
                  [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.website') })">
                  <span class="channel-icon">ğŸŒ</span>
                  <span class="channel-name">{{ lang.t('distribution.network.website') }}</span>
                </button>
                <button 
                  class="channel-btn additional-btn linktree"
                  (click)="selectSocialNetwork('linktree')"
                  [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.linktree') })">
                  <span class="channel-icon">ğŸ”—</span>
                  <span class="channel-name">{{ lang.t('distribution.network.linktree') }}</span>
                </button>
                <button 
                  class="channel-btn additional-btn signature"
                  (click)="selectSocialNetwork('signature')"
                  [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.signature') })">
                  <span class="channel-icon">âœï¸</span>
                  <span class="channel-name">{{ lang.t('distribution.network.signature') }}</span>
                </button>
                <button 
                  class="channel-btn additional-btn google"
                  (click)="selectSocialNetwork('google')"
                  [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.google') })">
                  <span class="channel-icon">ğŸ”</span>
                  <span class="channel-name">{{ lang.t('distribution.network.google') }}</span>
                </button>
                <button 
                  class="channel-btn additional-btn bing"
                  (click)="selectSocialNetwork('bing')"
                  [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.bing') })">
                  <span class="channel-icon">ğŸ”</span>
                  <span class="channel-name">{{ lang.t('distribution.network.bing') }}</span>
                </button>
                <button 
                  class="channel-btn additional-btn yahoo"
                  (click)="selectSocialNetwork('yahoo')"
                  [title]="lang.t('distribution.shareVia', { network: lang.t('distribution.network.yahoo') })">
                  <span class="channel-icon">ğŸ“°</span>
                  <span class="channel-name">{{ lang.t('distribution.network.yahoo') }}</span>
                </button>
              </div>
            </details>
          </div>
        </div>
      </div>
    }

  </div>
</div>
