<div class="distribution-page" dir="rtl">
  <!-- Back Button -->
  <div class="flex items-center mb-2">
    <button class="btn-back" (click)="goBack()">
      <span class="arrow-icon">â†’</span>
      {{ lang.t('distribution.back') }}
    </button>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="text-right">
      <h1 class="page-title">
        <span>ğŸ“¤</span> {{ lang.t('distribution.title') }}
      </h1>
      <p class="page-subtitle">
        {{ lang.t('distribution.subtitle') }}
      </p>
      
      <!-- Save Status Indicator -->
      @if (selectedQuestionnaire) {
        <div class="save-status-indicator" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
          @if (isSaving) {
            <span style="color: #9c27b0;">ğŸ’¾ ×©×•××¨...</span>
          } @else if (lastSaved) {
            <span style="color: #4caf50;">âœ“ × ×©××¨ {{ formatTime(lastSaved) }}</span>
          }
          @if (currentDistribution) {
            <span style="color: #2196f3; margin-right: 1rem;">âœ… ×™×© distribution ×¤×¢×™×œ</span>
          }
        </div>
      }
    </div>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Step 1: Select Questionnaire -->
    <div class="step-card gradient-green">
      <label class="step-label">×©×œ×‘ 1: ×‘×—×¨ ×©××œ×•×Ÿ</label>
      <select
        [(ngModel)]="selectedQuestionnaire"
        (ngModelChange)="onQuestionnaireChange()"
        class="select-input"
        name="questionnaire">
        <option value="">{{ lang.t('distribution.selectPlaceholder') || '×‘×—×¨ ×©××œ×•×Ÿ...' }}</option>
        @for (q of questionnaires; track q.id) {
          <option [value]="q.id">{{ q.title }}</option>
        }
      </select>
    </div>

    <!-- Step 2: Select Automatic Customer Response (Required) -->
    @if (selectedQuestionnaire) {
      <div class="step-card gradient-green">
        <div class="step-header-row">
          <label class="step-label">×©×œ×‘ 2: ×‘×—×¨ ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×— <span class="required-star">*</span></label>
          <button
            class="btn-create-template-outline"
            (click)="navigateToAutomations()">
            <span class="plus-icon">+</span>
            ×¦×•×¨ ××¢× ×” ×—×“×© ×œ×œ×§×•×—
            <span class="external-icon">â†—</span>
          </button>
        </div>

        <select
          [(ngModel)]="selectedTemplateId"
          (ngModelChange)="onTemplateChange($event)"
          class="select-input"
          name="template">
          <option value="">×‘×—×¨ ×ª×‘× ×™×ª...</option>
          <option value="none">×œ×œ× ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×—</option>
          @for (template of availableTemplates; track template.id) {
            <option [value]="template.id">{{ template.name }}</option>
          }
        </select>

        <!-- Info message if template was taken from bot -->
        @if (selectedTemplateId && selectedTemplateId !== 'none') {
          <div class="template-info-box">
            <span class="bot-icon">ğŸ¤–</span>
            <span>×ª×‘× ×™×ª ×–×• × ×œ×§×—×” ××‘×•×˜</span>
          </div>
        }

        <!-- Channel Selection (only when template is selected) -->
        @if (selectedTemplateId && selectedTemplateId !== 'none') {
          <div class="channels-selection">
            <label class="channels-label">
              ×‘×—×¨ ×¢×¨×•×¦×™ ×©×œ×™×—×” (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××”):
            </label>
            <div class="channels-checkboxes">
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('email')"
                  (change)="toggleChannel('email')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ“§</span>
                  Email
                </span>
              </label>
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('whatsapp')"
                  (change)="toggleChannel('whatsapp')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ’¬</span>
                  WhatsApp
                </span>
              </label>
              <label class="channel-checkbox">
                <input
                  type="checkbox"
                  [checked]="isChannelSelected('sms')"
                  (change)="toggleChannel('sms')">
                <span class="channel-label">
                  <span class="channel-icon">ğŸ“±</span>
                  SMS
                </span>
              </label>
            </div>
            @if (selectedChannels.length === 0) {
              <p class="channels-error-text">
                ×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×¢×¨×•×¥ ××—×“
              </p>
            }
          </div>
        }

        <!-- Error message if not selected -->
        @if (!isStep2Valid() && selectedQuestionnaire) {
          <p class="step-error-text">
            ×™×© ×œ×‘×—×•×¨ ××¢× ×” ××•×˜×•××˜×™ ××• "×œ×œ× ××¢× ×” ××•×˜×•××˜×™ ×œ×œ×§×•×—" ×›×“×™ ×œ×”××©×™×š
          </p>
        }
      </div>
    }

    <!-- Step 3: Distribution Links (Only after template selection) -->
    @if (canShowStep3()) {
      <div class="step-card gradient-purple">
        <label class="step-label">×©×œ×‘ 3: ×§×™×©×•×¨×™ ×”×¤×¦×”</label>

        <!-- Info box about automatic detection -->
        <div class="info-box">
          <span class="bot-icon">ğŸ¤–</span>
          <span>×”×œ×™× ×§ ×™×–×”×” ××•×˜×•××˜×™×ª ××ª ×”××™×§×•× (WhatsApp, ××ª×¨, ×“×£ × ×—×™×ª×”) ×›×©××™×©×”×• ×œ×•×—×¥ ×¢×œ×™×•</span>
        </div>

        <!-- Link Rows: Form, Chat, QR - Simplified -->
        <div class="links-container-simple">
          <!-- Row 1: Form Link -->
          <div class="link-row-simple">
            <div class="link-label-simple">
              <span class="link-icon">ğŸ“„</span>
              <span>×œ×™× ×§ ×˜×•×¤×¡</span>
            </div>
            <div class="link-content-simple">
              <code class="link-url-simple">{{ formLink || '×œ× ×–××™×Ÿ' }}</code>
              <button class="copy-btn-simple" (click)="copyLink(formLink, 'form')" [disabled]="!formLink" title="×”×¢×ª×§ ×œ×™× ×§">
                ğŸ“‹
              </button>
            </div>
          </div>

          <!-- Row 2: Chat Link -->
          <div class="link-row-simple">
            <div class="link-label-simple">
              <span class="link-icon">ğŸ’¬</span>
              <span>×œ×™× ×§ ×¦'××˜</span>
            </div>
            <div class="link-content-simple">
              <code class="link-url-simple">{{ chatLink || '×œ× ×–××™×Ÿ' }}</code>
              <button class="copy-btn-simple" (click)="copyLink(chatLink, 'chat')" [disabled]="!chatLink" title="×”×¢×ª×§ ×œ×™× ×§">
                ğŸ“‹
              </button>
            </div>
          </div>

          <!-- Row 3: QR Link -->
          <div class="link-row-simple">
            <div class="link-label-simple">
              <span class="link-icon">ğŸ“±</span>
              <span>×œ×™× ×§ QR</span>
            </div>
            <div class="link-content-simple">
              <code class="link-url-simple">{{ qrLink || '×œ× ×–××™×Ÿ' }}</code>
              <button class="copy-btn-simple" (click)="copyLink(qrLink, 'qr')" [disabled]="!qrLink" title="×”×¢×ª×§ ×œ×™× ×§">
                ğŸ“‹
              </button>
            </div>
          </div>
        </div>
      </div>
    }

  </div>
</div>
